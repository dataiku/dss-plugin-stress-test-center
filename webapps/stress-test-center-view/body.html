<script src="/plugins/stress-test-center/resource/spin.min.js" type="text/javascript"></script>
<script src="/plugins/stress-test-center/resource/angular.min.js" type="text/javascript"></script>
<script type="text/javascript">
    var app = angular.module("StressTestCenter", []);
</script>
<script src="/plugins/stress-test-center/resource/js/helpers.js" type="text/javascript"></script>
<link rel="stylesheet" href="/static/public/styles/1.0.0/typography.css"/>
<link rel="stylesheet" href="/static/public/styles/1.0.0/fonts.css"/>

<body ng-app = "StressTestCenter"
      ng-controller = "VizController"
      class="report-box"
      ng-click="uiState.openFeatureSelectors = {}"
      tabindex="0">
    <div ng-if="modal.type"
         class="modal-background"
         tabindex=0
         ng-keyup="$event.keyCode == 27 && removeModal()"
         ng-click="removeModal($event)">
    </div>

    <div class="webapp-main">
        <div class="webapp-section webapp-section__settings">
            <div class="settings__subsection">
                <div class="grand-title-b flex settings__subsection-header">
                    Stress tests
                    <i class="small-title-b icon-info-sign icon--hoverable" ng-mouseover="showTooltip($event)" ng-mouseleave="showTooltip($event)">
                        <div class="settings__help-text tooltip--hidden">
                            <i class="icon-info-sign"></i>
                            Select the tests corresponding to corruptions you expect to have at deployment time, and assess the robustness of your model
                        </div>
                    </i>
                </div>
                <form class="settings__subsection-form">
                    <div class="control-group">
                        <label for="samples" class="label-text">Sample size for perturbation tests</label>
                        <input type="number" id="samples" ng-model="samples" placeholder="0.5"  step="0.01" min="0" max="100">
                        <div class="text-tiny">
                            Set the percentage of rows to be used for the selected stress tests
                        </div>
                    </div>
                </form>
                <div class="dku-btn-container--right-align">
                    <button class="dku-btn dku-btn-primary"
                            id="run-button"
                            type="button"
                            ng-class="{'dku-btn-primary--disabled': uiState.loadingResult}"
                            ng-click="runAnalysis()">
                        Run tests
                    </button>
                </div>
            </div>

            <div class="settings__subsection">
                <div class="flex small-title-b settings__subsection-header">
                    <label class="switch">
                        <input type="checkbox" ng-model="perturbations.PRIOR_SHIFT.$activated">
                        <div class="slider round"></div>
                    </label>
                    Target distribution
                    <i class="icon-info-sign icon--hoverable" ng-mouseover="showTooltip($event)" ng-mouseleave="showTooltip($event)">
                        <div class="settings__help-text tooltip--hidden">
                            <i class="icon-info-sign"></i>
                            Modifies the target distribution by resampling
                        </div>
                    </i>
                </div>
                <form class="settings__subsection-form">
                    <div class="control-group">
                        <label ng-click="openFeatureSelector('PRIOR_SHIFT', $event)"
                            class="label-text">
                            Affected class
                        </label>
                        <div class="custom-dropdown" ng-click="openFeatureSelector('PRIOR_SHIFT', $event)">
                            <div class="flex custom-dropdown__title">
                                {{ perturbations.PRIOR_SHIFT.params.cl || "Select a class" }}
                                <i class="icon-caret-down"></i>
                            </div>
                            <div class="custom-dropdown__body" ng-if="uiState.openFeatureSelectors.PRIOR_SHIFT">
                                <div class="custom-dropdown-row"
                                    ng-click="perturbations.PRIOR_SHIFT.params.cl = class"
                                    ng-repeat="class in modelInfo.targetClasses">
                                    <i class="icon-ok" ng-class="{'icon--hidden': perturbations.PRIOR_SHIFT.params.cl !== class}"></i>
                                    <div>{{ class }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="priorShift" class="label-text">Selected class frequency after perturbation</label>
                        <input type="number" id="priorShift" ng-model="perturbations.PRIOR_SHIFT.params.samples_fraction" placeholder="0.5"  step="0.01" min="0">
                    </div>
                </form>
            </div>

            <div class="settings__subsection">
                <div class="flex small-title-b settings__subsection-header">
                    <label class="switch">
                        <input type="checkbox" ng-model="perturbations.MISSING_VALUES.$activated">
                        <div class="slider round"></div>
                    </label>
                    Missing Values Enforcer
                    <i class="icon-info-sign icon--hoverable" ng-mouseover="showTooltip($event)" ng-mouseleave="showTooltip($event)">
                        <div class="settings__help-text tooltip--hidden">
                            <i class="icon-info-sign"></i>
                            Randomly inserts missing values
                        </div>
                    </i>
                </div>
                <form class="settings__subsection-form">
                    <div class="control-group">
                        <label ng-click="openFeatureSelector('MISSING_VALUES', $event)"
                            class="label-text">
                            Affected columns
                        </label>
                        <div class="custom-dropdown"
                            ng-click="openFeatureSelector('MISSING_VALUES', $event)">
                            <div class="flex custom-dropdown__title">
                                {{ getFeatureDropdownPlaceholder('MISSING_VALUES') }}
                                <i class="icon-caret-down"></i>
                            </div>
                            <div class="custom-dropdown__body" ng-if="uiState.openFeatureSelectors.MISSING_VALUES">
                                <div class="custom-dropdown-row"
                                    ng-click="feature.$selected = !feature.$selected; $event.stopPropagation()"
                                    ng-repeat="feature in perturbations.MISSING_VALUES.available_columns">
                                    <i class="icon-ok" ng-class="{'icon--hidden': !feature.$selected}"></i>
                                    <i class="icon-font" ng-show="feature.feature_type === 'CATEGORY'"></i>
                                    <i class="numerical" ng-show="feature.feature_type === 'NUMERIC'"></i>
                                    <div>{{ feature.name }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="missingValues" class="label-text">Proportion of affected samples</label>
                        <input type="number" id="missingValues" ng-model="perturbations.MISSING_VALUES.params.samples_fraction" value="0.5" placeholder="0.5" step="0.01" min="0">
                    </div>
                </form>
            </div>

            <div class="settings__subsection">
                <div class="flex small-title-b settings__subsection-header">
                    <label class="switch">
                        <input type="checkbox" ng-model="perturbations.SCALING.$activated">
                        <div class="slider round"></div>
                    </label>
                    Scaling Perturbation
                    <i class="icon-info-sign icon--hoverable" ng-mouseover="showTooltip($event)" ng-mouseleave="showTooltip($event)">
                        <div class="settings__help-text tooltip--hidden">
                            <i class="icon-info-sign"></i>
                            Changes the order of magnitude of each feature by some random scaling
                        </div>
                    </i>
                </div>
                <form class="settings__subsection-form">
                    <div class="control-group">
                        <label ng-click="openFeatureSelector('SCALING', $event)"
                            class="label-text">
                            Affected features
                        </label>
                        <div class="custom-dropdown" ng-click="openFeatureSelector('SCALING', $event)">
                            <div class="flex custom-dropdown__title">
                                {{ getFeatureDropdownPlaceholder('SCALING') }}
                                <i class="icon-caret-down"></i>
                            </div>
                            <div class="custom-dropdown__body" ng-if="uiState.openFeatureSelectors.SCALING">
                                <div class="custom-dropdown-row"
                                    ng-click="feature.$selected = !feature.$selected; $event.stopPropagation()"
                                    ng-repeat="feature in perturbations.SCALING.available_columns">
                                    <i class="icon-ok" ng-class="{'icon--hidden': !feature.$selected}"></i>
                                    <i class="icon-font" ng-show="feature.feature_type === 'CATEGORY'"></i>
                                    <i class="numerical" ng-show="feature.feature_type === 'NUMERIC'"></i>
                                    <div>{{ feature.name }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="scaling" class="label-text">Proportion of affected samples</label>
                        <input type="number" id="scaling" ng-model="perturbations.SCALING.params.samples_fraction" value="0.5" placeholder="0.5" step="0.01" min="0">
                    </div>
                </form>
            </div>
        </div>

        <div class="webapp-section webapp-section__results">
            <div class="empty-state" ng-if="!metrics && !uiState.loadingResult">
                <div class="empty-state__title">
                    Put your model through a battery of tests to see how it handles the unexpected
                </div>
                <div class="empty-state__subtitle">
                    Select the tests corresponding to corruptions you expect to have at deployment time, and assess the robustness of your model.
                </div>
                <div>
                    <button class="dku-btn dku-btn-primary"
                            id="run-button"
                            type="button"
                            ng-class="{'dku-btn-primary--disabled': uiState.loadingResult}"
                            ng-click="runAnalysis()">
                        Run tests
                    </button>
                </div>
            </div>

            <div class="spinner-div" ng-if="uiState.loadingResult">
                <spinner></spinner>
            </div>

            <div class="tutu" ng-if="metrics && !uiState.loadingResult">
                <div class="metric-subsection">
                    <div class="flex row-header grand-title-b">
                        Robustness metrics
                    </div>
                    <div class="flex">
                        <table class="table-metric">
                            <thead>
                                <tr>
                                    <th scope="col" class="fake-cell"></th>
                                    <th scope="col" class="cell small-title-b top-cell--blue">Performance</th>
                                    <th scope="col" class="cell small-title-b top-cell--orange">Robustness</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="metric in metrics">
                                    <td class="cell text-highlight">{{ perturbations[metric['attack_type']].displayName }}</td>
                                    <td class="cell text-sb">{{ metric['accuracy_drop'] }}%</td>
                                    <td class="cell text-sb">{{ metric['robustness'] }}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <hr/>

                <div class="sample-subsection">
                    <div class="flex row-header grand-title-b">
                        Critical samples
                    </div>
                    <div class="explanation-box">
                        The critical samples are the most sensitive to perturbations, and highlight regions where the model prediction is highly uncertain (presenting large confidence fluctuations).
                    </div>
                    <div class="flex dku-grid">
                        <div ng-repeat="sample in critical_samples">
                            <table class="table-sample table-striped">
                                <thead>
                                    <tr>
                                        <th class="top-cell--blue title-b">
                                            <div class="flex top-cell__row">
                                                <div>{{ uncertainties[$index] }}</div>
                                                <div>0.63</div>
                                            </div>
                                            <div class="flex top-cell__row">
                                                <div>Uncertainty score</div>
                                                <div class="text-lighter">Probability</div>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="(key, value) in sample">
                                    <td>
                                        {{key}}
                                        <span class="text-lighter">= {{value}}</span>
                                    </td>
                                    </tr>
                                </tbody>

                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</body>


