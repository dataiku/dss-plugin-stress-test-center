<script src="/plugins/stress-test-center/resource/spin.min.js" type="text/javascript"></script>
<script src="/plugins/stress-test-center/resource/angular.min.js" type="text/javascript"></script>
<script type="text/javascript">
    var app = angular.module("StressTestCenter", []);
</script>
<script src="/plugins/stress-test-center/resource/js/helpers.js" type="text/javascript"></script>
<link rel="stylesheet" href="/static/public/styles/1.0.0/typography.css"/>
<link rel="stylesheet" href="/static/public/styles/1.0.0/fonts.css"/>

<body ng-app = "StressTestCenter"
      ng-controller = "VizController"
      class="report-box"
      ng-click="$broadcast('closeDropdowns', $event.target)"
      ng-keyup="$broadcast('closeDropdowns')"
      tabindex="0">
    <div ng-if="modal.type"
         class="modal-background"
         tabindex="0"
         ng-keyup="$event.keyCode == 27 && removeModal()"
         ng-click="removeModal($event)">
    </div>

    <div class="webapp-main">
        <div class="webapp-section webapp-section__settings">
            <div class="settings__subsection">
                <div class="grand-title-b flex settings__subsection-header">
                    Stress tests
                    <help-icon class="small-title-b" help-text="Select the tests corresponding to corruptions you expect to have at deployment time, and assess the robustness of your model"></help-icon>
                </div>
                <form class="settings__subsection-form">
                    <div class="control-group">
                        <label for="samples" class="label-text">Sample size for perturbation tests</label>
                        <input type="number" id="samples" ng-model="samples" value="100"  step="0.01" min="0" max="100">
                        <div class="text-tiny">
                            Set the percentage of rows to be used for the selected stress tests
                        </div>
                    </div>
                </form>
                <div class="dku-btn-container--right-align">
                    <button class="dku-btn dku-btn-primary"
                            id="run-button"
                            type="button"
                            ng-class="{'dku-btn-primary--disabled': uiState.loadingResult}"
                            ng-click="runAnalysis()">
                        Run tests
                    </button>
                </div>
            </div>

            <div class="settings__subsection">
                <div class="flex small-title-b settings__subsection-header">
                    <label class="switch">
                        <input type="checkbox" ng-model="perturbations.PRIOR_SHIFT.$activated">
                        <div class="slider round"></div>
                    </label>
                    {{ perturbations.PRIOR_SHIFT.displayName }}
                    <help-icon help-text="Modifies the target distribution by resampling"></help-icon>
                </div>
                <form class="settings__subsection-form">
                    <div custom-dropdown
                         possible-values="modelInfo.targetClasses"
                         item="perturbations.PRIOR_SHIFT.params.cl"
                         item-name="class"
                         label="Affected class">
                    </div>
                    <div class="control-group">
                        <label for="priorShift" class="label-text">Selected class frequency after perturbation</label>
                        <input type="number" id="priorShift" ng-model="perturbations.PRIOR_SHIFT.params.samples_fraction" placeholder="0.5"  step="0.01" min="0">
                    </div>
                </form>
            </div>

            <div class="settings__subsection">
                <div class="flex small-title-b settings__subsection-header">
                    <label class="switch">
                        <input type="checkbox" ng-model="perturbations.MISSING_VALUES.$activated">
                        <div class="slider round"></div>
                    </label>
                    {{ perturbations.MISSING_VALUES.displayName }}
                    <help-icon help-text="Randomly inserts missing values"></help-icon>
                </div>
                <form class="settings__subsection-form">
                    <div custom-dropdown
                         possible-values="perturbations.MISSING_VALUES.availableColumns"
                         items="perturbations.MISSING_VALUES.selected_features"
                         item-name="feature"
                         item-image="featureToTypeIcon"
                         label="Affected features">
                    </div>
                    <div class="control-group">
                        <label for="missingValues" class="label-text">Proportion of affected samples</label>
                        <input type="number" id="missingValues" ng-model="perturbations.MISSING_VALUES.params.samples_fraction" value="0.5" placeholder="0.5" step="0.01" min="0">
                    </div>
                </form>
            </div>

            <div class="settings__subsection">
                <div class="flex small-title-b settings__subsection-header">
                    <label class="switch">
                        <input type="checkbox" ng-model="perturbations.SCALING.$activated">
                        <div class="slider round"></div>
                    </label>
                    {{ perturbations.SCALING.displayName }}
                    <help-icon help-text="Changes the order of magnitude of each feature by some random scaling"></help-icon>
                </div>
                <form class="settings__subsection-form">
                    <div custom-dropdown
                         possible-values="perturbations.SCALING.availableColumns"
                         items="perturbations.SCALING.selected_features"
                         item-name="feature"
                         item-image="featureToTypeIcon"
                         label="Affected features">
                    </div>
                    <div class="control-group">
                        <label for="scaling" class="label-text">Proportion of affected samples</label>
                        <input type="number" id="scaling" ng-model="perturbations.SCALING.params.samples_fraction" value="0.5" placeholder="0.5" step="0.01" min="0">
                    </div>
                </form>
            </div>
        </div>

        <div class="webapp-section webapp-section__results">
            <div class="empty-state" ng-if="!metrics && !uiState.loadingResult">
                <div class="empty-state__title">
                    Put your model through a battery of tests to see how it handles the unexpected
                </div>
                <div class="empty-state__subtitle">
                    Select the tests corresponding to corruptions you expect to have at deployment time, and assess the robustness of your model.
                </div>
                <div>
                    <button class="dku-btn dku-btn-primary"
                            id="run-button"
                            type="button"
                            ng-class="{'dku-btn-primary--disabled': uiState.loadingResult}"
                            ng-click="runAnalysis()">
                        Run tests
                    </button>
                </div>
            </div>

            <div class="spinner-div" ng-if="uiState.loadingResult">
                <spinner></spinner>
            </div>

            <div class="tutu" ng-if="metrics && !uiState.loadingResult">
                <div class="metric-subsection">
                    <div class="flex row-header grand-title-b">
                        Robustness metrics
                    </div>
                    <div class="flex">
                        <table class="table-metric">
                            <thead>
                                <tr>
                                    <th scope="col" class="fake-cell"></th>
                                    <th scope="col" class="cell small-title-b top-cell--blue">Performance</th>
                                    <th scope="col" class="cell small-title-b top-cell--orange">Robustness</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="metric in metrics">
                                    <td class="cell text-highlight">{{ perturbations[metric['attack_type']].displayName }}</td>
                                    <td class="cell text-sb">{{ metric['accuracy_drop'] }}%</td>
                                    <td class="cell text-sb">{{ metric['robustness'] }}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <hr/>

                <div class="sample-subsection">
                    <div class="flex row-header grand-title-b">
                        Critical samples
                    </div>
                    <div class="explanation-box">
                        The critical samples are the most sensitive to perturbations, and highlight regions where the model prediction is highly uncertain (presenting large confidence fluctuations).
                    </div>
                    <div class="flex dku-grid">
                        <div ng-repeat="sample in critical_samples">
                            <table class="table-sample table-striped">
                                <thead>
                                    <tr>
                                        <th class="top-cell--blue title-b">
                                            <div class="flex top-cell__row">
                                                <div>{{ uncertainties[$index] }}</div>
                                                <div>0.63</div>
                                            </div>
                                            <div class="flex top-cell__row">
                                                <div>Uncertainty score</div>
                                                <div class="text-lighter">Probability</div>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="(key, value) in sample">
                                    <td>
                                        {{key}}
                                        <span class="text-lighter">= {{value}}</span>
                                    </td>
                                    </tr>
                                </tbody>

                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</body>


