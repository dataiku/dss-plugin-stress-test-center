<script src="/plugins/stress-test-center/resource/spin.min.js" type="text/javascript"></script>
<script src="/plugins/stress-test-center/resource/angular.min.js" type="text/javascript"></script>
<script type="text/javascript">
    var app = angular.module("StressTestCenter", []);
</script>
<script src="/plugins/stress-test-center/resource/js/helpers.js" type="text/javascript"></script>
<link rel="stylesheet" href="/static/public/styles/1.0.0/typography.css"/>
<link rel="stylesheet" href="/static/public/styles/1.0.0/fonts.css"/>
<link rel="stylesheet" href="/static/public/styles/1.0.0/forms.css"/>

<body  ng-app = "StressTestCenter" ng-controller = "VizController" class="report-box">
    <div ng-if="modal.type"
         class="modal-background"
         tabindex=0
         ng-keyup="$event.keyCode == 27 && removeModal()"
         ng-click="removeModal($event)">
    </div>

    <div class="webapp-main">
        <div class="webapp-section">
            <div class="introduction-section">
                <div class="flex row-header">
                    <div class="grand-title-sb">
                        Stress tests
                    </div>
                    <div>
                        <button class="dku-btn dku-btn-primary" 
                                id="run-button"
                                type="button"
                                ng-class="{'dku-btn-primary--disabled': uiState.loadingResult}"
                                ng-click="runAnalysis()">
                            Compute
                        </button>
                    </div>
                </div>

                <div class="explanation-box text-r">
                    The Stress test center evaluates the impact on the model performances of various types of changes and corruptions in your data.
                    You can select the stress tests corresponding to corruptions you expect to have at deployment time, and that you expect your model to be robust to.
                    The robustness metrics score the resilience of your model to the desired perturbations and allows you to compare both accuracy and robustness of multiple models before deployment.
                </div>
            </div>

            <div class="perturbation-design-row">
                <div class="flex">
                    <div class="perturbation-rows">
                        <div ng-repeat="(perturbation, attributes) in perturbations"
                            class="flex perturbation-row"
                            ng-click="uiState.selectedRow = perturbation"
                            ng-class="{'row--selected': uiState.selectedRow == perturbation}">
                            <div class="text-sb" ng-class="{'text--deactivated': !attributes.$activated}">
                                {{ attributes.displayName }}
                            </div>
                            <div>
                                <label class="switch">
                                    <input type="checkbox" ng-model="attributes.$activated">
                                    <div class="slider round"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="perturbation-details" ng-show="uiState.selectedRow == 'PRIOR_SHIFT'">
                        <div class="explanation-box">
                            <div class="flex title-sb">
                                Target Distribution Perturbation
                            </div>
                            <div class="flex text-r">
                                The target distribution perturbation modifies the data target distribution by resampling.
                            </div>
                        </div>
                        <form class="flex row-param">
                            <div class="control-group">
                                <label class="text label-text">Class to perturb</label>
                                <select ng-options="class for class in modelInfo.targetClasses" ng-model="perturbations.PRIOR_SHIFT.params.cl"></select>
                            </div>
                            <div class="control-group">
                                <label for="priorShift" class="text label-text">Selected class frequency after perturbation</label>
                                <input type="number" id="priorShift" ng-model="perturbations.PRIOR_SHIFT.params.samples_fraction" placeholder="0.5"  step=0.01 min=0>
                            </div>
                    </div>

                    <div class="perturbation-details" ng-show="uiState.selectedRow == 'ADVERSARIAL'">
                        <div class="explanation-box">
                            <div class="flex title-sb">
                                Adversarial Attack
                            </div>
                            <div class="flex text-r">
                                The adversarial attack performs minimal feature perturbation to change sample predictions.
                            </div>
                        </div>
                        <form class="flex row-param">
                            <div class="control-group">
                                <label for="advAttack" class="text label-text">Proportion of affected samples</label>
                                <input type="number" id="advAttack" ng-model="perturbations.ADVERSARIAL.params.samples_fraction" value="0.5" placeholder=0.5 step=0.01 min=0>
                            </div>
                    </div>

                    <div class="perturbation-details" ng-show="uiState.selectedRow == 'MISSING_VALUES'">
                        <div class="explanation-box">
                            <div class="flex title-sb">
                                Missing Values Enforcer
                            </div>
                            <div class="flex text-r">
                                The missing values enforcer randomly inserts missing values.
                            </div>
                        </div>

                        <form class="flex row-param">
                            <div class="control-group">
                                <label for="missingValues" class="text label-text">Proportion of affected samples</label>
                                <input type="number" id="missingValues" ng-model="perturbations.MISSING_VALUES.params.samples_fraction" value="0.5" placeholder=0.5 step=0.01 min=0>
                            </div>
                    </div>

                    <div class="perturbation-details" ng-show="uiState.selectedRow == 'SCALING'">
                        <div class="explanation-box">
                            <div class="flex title-sb">
                                Scaling Perturbation
                            </div>
                            <div class="flex text-r">
                                The scaling perturbation changes the order of magnitude of each feature by some random scaling.
                            </div>
                        </div>
                        <form class="flex row-param">
                            <div class="control-group">
                                <label for="scaling" class="text label-text">Proportion of affected samples</label>
                                <input type="number" id="scaling" ng-model="perturbations.SCALING.params.samples_fraction" value="0.5" placeholder=0.5 step=0.01 min=0>
                            </div>
                    </div>

                    <div class="perturbation-details" ng-show="uiState.selectedRow == 'REPLACE_WORD'">
                        <div class="explanation-box">
                            <div class="flex title-sb">
                                Replace Word
                            </div>
                            <div class="flex text-r">
                                Replace Word replaces random words with similar words (close in the embedding space).
                            </div>
                        </div>
                        <form class="flex row-param">
                            <label for="replaceWord" class="text label-text">
                                Proportion of affected samples
                            </label>
                            <div class="control-group">
                                <input type="number" id="replaceWord" ng-model="perturbations.REPLACE_WORD.params.samples_fraction" value="0.5" placeholder=0.5 step=0.01 min=0>
                            </div>
                    </div>

                    <div class="perturbation-details" ng-show="uiState.selectedRow == 'TYPOS'">
                        <div class="explanation-box">
                            <div class="flex title-sb">
                                Typos in words
                            </div>
                            <div class="flex text-r">
                                Typos inserts/deletes characters to simulate typos in words.
                            </div>
                        </div>
                        <div class="flex row-param">
                            <label for="typos" class="text label-text">
                                Proportion of affected samples
                            </label>
                            <div class="control-group">
                                <input type="number" id="typos" ng-model="perturbations.TYPOS.params.samples_fraction" value="0.5" placeholder=0.5 step=0.01 min=0>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="webapp-section" ng-if="!metrics && !uiState.loadingResult">
            <div class="flex">
                <div class="empty-state">
                    <div class="empty-state__title">
                        Stress Test Center
                    </div>
                    <div class="empty-state__subtitle">
                        Put your model through a battery of tests to see how it handles the unexpected and assess its robustness
                    </div>
                </div>
            </div>
        </div>

        <div class="webapp-section spinner-div" ng-if="uiState.loadingResult">
            <div class="jcc">
                <spinner></spinner>
            </div>
        </div>

        <div class="webapp-section webapp-section__result" ng-if="metrics && !uiState.loadingResult">
            <div class="metric-subsection">
                <div class="flex row-header grand-title-sb">
                    Robustness metrics
                </div>
                <div class="flex">
                    <table class="table-metric">
                        <thead>
                            <tr>
                                <th scope="col" class="fake-cell"></th>
                                <th scope="col" class="cell small-title-sb top-cell--blue">Performance</th>
                                <th scope="col" class="cell small-title-sb top-cell--orange">Robustness</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="metric in metrics">
                                <td class="cell text-highlight">{{ perturbations[metric['attack_type']].displayName }}</td>
                                <td class="cell text-sb">{{ metric['accuracy_drop'] }}%</td>
                                <td class="cell text-sb">{{ metric['robustness'] }}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <hr/>

            <div class="sample-subsection">
                <div class="flex row-header grand-title-sb">
                    Critical samples
                </div>
                <div class="explanation-box text-r">
                    The critical samples are the most sensitive to perturbations, and highlight regions where the model prediction is highly uncertain (presenting large confidence fluctuations).
                </div>
                <div class="flex dku-grid">
                    <div ng-repeat="sample in critical_samples">
                        <table class="table-sample table-striped">
                            <thead>
                                <tr>
                                    <th class="top-cell--blue title-sb">
                                        <div class="flex top-cell__row">
                                            <div>{{ sample['uncertainty'] }}</div>
                                            <div>0.63</div>
                                        </div>
                                        <div class="flex top-cell__row">
                                            <div class="text-r">Uncertainty score</div>
                                            <div class="text-r text-lighter">Probability</div>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="(key, value) in filterUncertainty(sample)">
                                <td>
                                    {{key}}
                                    <span class="text-lighter">= {{value}}</span>
                                </td>
                                </tr>
                            </tbody>

                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
</body>


